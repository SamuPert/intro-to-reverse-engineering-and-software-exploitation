#include <stdio.h>
#include <stdlib.h>

#define INITIAL_BANNER "   _____      _                  _____ _           _ _                       \n\
  / ____|    | |                / ____| |         | | |                      \n\
 | |    _   _| |__   ___ _ __  | |    | |__   __ _| | | ___ _ __   __ _  ___ \n\
 | |   | | | | '_ \\ / _ \\ '__| | |    | '_ \\ / _` | | |/ _ \\ '_ \\ / _` |/ _ \\\n\
 | |___| |_| | |_) |  __/ |    | |____| | | | (_| | | |  __/ | | | (_| |  __/\n\
  \\_____\\__, |_.__/ \\___|_|     \\_____|_| |_|\\__,_|_|_|\\___|_| |_|\\__, |\\___|\n\
         __/ |                                                     __/ |     \n\
        |___/                                                     |___/      \n"


const char* JOKES[] = 
{
  "I am a full stack engineer, which means if you give me one more task my stack will overflow!",
  "Behind every ambitious developer is a GitHub full of unfinished side projects and half abandoned notes.",
  "In case of apocalypse do \"git push --force\""
};

void get_shell() {  system("/bin/sh"); }

void setup()
{
  // DISABLE BUFFERING
  setvbuf(stdin, NULL, _IONBF, 0);
  setvbuf(stdout, NULL, _IONBF, 0);
  setvbuf(stderr, NULL, _IONBF, 0);
  srand(time(NULL));
}

void init_banner(char* banner)
{
  memcpy(banner, INITIAL_BANNER, sizeof(INITIAL_BANNER));
  banner[ sizeof(INITIAL_BANNER) ] = '\0';
}


void read_string(char* buffer, int n)
{
  if(n < 0) return;

  size_t i;
  for (i = 0; i < n; i++)
  {
    char c;
    if( fread(&c, sizeof(char), 1, stdin) != 1 || c == '\n') break;
    buffer[i] = c;
  }
  buffer[i] = '\0';
  fflush(stdin);
}


void read_buffer(char* buffer, int n)
{
  if(n < 0) return;

  size_t i;
  for (i = 0; i < n; i++)
  {
    char c;
    if( fread(&c, sizeof(char), 1, stdin) != 1 ) break;
    buffer[i] = c;
  }
  fflush(stdin);
}

void print_menu(char* banner)
{
  printf("%s\n", banner);
  printf("A. Say hello.\n");
  printf("B. Tell me a joke.\n");
  // printf("DBG. [DEBUG FEATURE] Change banner.\n");
  printf("X. Quit\n");
  printf("\n");
}

void chall()
{
  char name[30];
  char banner[630];

  init_banner(banner);

  printf("Hi, what's your name?\n> ");
  scanf("%29s", name);
  name[29] = '\0';
  getchar();

  for (;;)
  {
    char choice[5];
    print_menu(banner);

    printf("> ");
    read_string(choice, 4);

    if(strncmp(choice, "A", 1) == 0)
    {
      printf("Hello %s!\n", name);
    }else if(strncmp(choice, "B", 1) == 0)
    {
      printf("%s\n", JOKES[rand() % ((sizeof (JOKES) / sizeof (const char *)))]);
    }else if(strncmp(choice, "X", 1) == 0)
    {
      break;
    }else if(strncmp(choice, "DBG", 3) == 0)
    {
      printf("Insert new banner size: ");
      int size = 0;
      scanf("%d", &size);
      getchar();
      if(size <= 0) break;

      printf("New banner: ");
      read_buffer(banner, size);
      fflush(stdin);

    }


  }

  printf("Bye bye.\n\n");
  
}

int main(int argc, char const *argv[])
{
  setup();
  chall();
  return 0;
}
